<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Swift,CSP,Concurrency," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="前言这篇文章的主要内容，是从 Go Concurrency Patterns 翻译过来的。
原文是介绍 Golang 里面的 CSP 并发模型(Communicating Sequential Processes)，这里则是使用一个基于 Swift3.0 的库 Venice 编写的代码。
这篇文章的主要目的，并不是鼓励大家立刻就用 Swift 进行后端开发(至少不是目前这个阶段)，但是，对于想尝试">
<meta property="og:type" content="article">
<meta property="og:title" content="CSP Concurrency Patterns In Swift">
<meta property="og:url" content="http://qqmailteam.github.io/2016/04/10/CSP-Concurrency-Patterns-In-Swift/index.html">
<meta property="og:site_name" content="QQ邮箱的技术博客">
<meta property="og:description" content="前言这篇文章的主要内容，是从 Go Concurrency Patterns 翻译过来的。
原文是介绍 Golang 里面的 CSP 并发模型(Communicating Sequential Processes)，这里则是使用一个基于 Swift3.0 的库 Venice 编写的代码。
这篇文章的主要目的，并不是鼓励大家立刻就用 Swift 进行后端开发(至少不是目前这个阶段)，但是，对于想尝试">
<meta property="og:updated_time" content="2016-04-13T07:44:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CSP Concurrency Patterns In Swift">
<meta name="twitter:description" content="前言这篇文章的主要内容，是从 Go Concurrency Patterns 翻译过来的。
原文是介绍 Golang 里面的 CSP 并发模型(Communicating Sequential Processes)，这里则是使用一个基于 Swift3.0 的库 Venice 编写的代码。
这篇文章的主要目的，并不是鼓励大家立刻就用 Swift 进行后端开发(至少不是目前这个阶段)，但是，对于想尝试">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> CSP Concurrency Patterns In Swift | QQ邮箱的技术博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-74497486-1', 'auto');
  ga('send', 'pageview');
</script>







  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">QQ邮箱的技术博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            博文
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-heartbeat fa-fw"></i> <br />
            
            公益404
          </a>
        </li>
      

      
      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                CSP Concurrency Patterns In Swift
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">jasonjfeng(冯牮) 发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-10T22:45:16+08:00" content="2016-04-10">
              2016-04-10
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/10/CSP-Concurrency-Patterns-In-Swift/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/04/10/CSP-Concurrency-Patterns-In-Swift/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这篇文章的主要内容，是从 <a href="https://talks.golang.org/2012/concurrency.slide" target="_blank" rel="external">Go Concurrency Patterns</a> 翻译过来的。</p>
<p>原文是介绍 <a href="http://golang.info/" target="_blank" rel="external">Golang</a> 里面的 <a href="https://en.wikipedia.org/wiki/Communicating_sequential_processes" target="_blank" rel="external">CSP</a> 并发模型(Communicating Sequential Processes)，这里则是使用一个基于 Swift3.0 的库 <a href="https://github.com/VeniceX/Venice" target="_blank" rel="external">Venice</a> 编写的代码。</p>
<p>这篇文章的主要目的，并不是鼓励大家立刻就用 Swift 进行后端开发(至少不是目前这个阶段)，但是，对于想尝试全栈开发的 iOS 工程师来说，则可以通过这篇文章入门学习 CSP 这种并发编程模型。</p>
<p><em>2016/04/08 update: 为了成功运行本文中的代码，需要安装 <a href="https://swift.org/builds/development/xcode/swift-DEVELOPMENT-SNAPSHOT-2016-03-24-a/swift-DEVELOPMENT-SNAPSHOT-2016-03-24-a-osx.pkg" target="_blank" rel="external">https://swift.org/builds/development/xcode/swift-DEVELOPMENT-SNAPSHOT-2016-03-24-a/swift-DEVELOPMENT-SNAPSHOT-2016-03-24-a-osx.pkg</a> 这个版本的 swift。</em></p>
<p><em>2016/04/13 update: <a href="https://github.com/VeniceX/Venice" target="_blank" rel="external">Venice</a> 里面的 Channel 不再支持基于自定义运算符的读写操作，只能使用 func api。</em></p>
<h3 id="为什么要讨论并发-concurrency"><a href="#为什么要讨论并发-concurrency" class="headerlink" title="为什么要讨论并发 (concurrency)"></a>为什么要讨论并发 (concurrency)</h3><p>观察一下我们周围，能发现什么？</p>
<p>我们的世界里发生的事情，总是一步一步按顺序执行的吗？</p>
<p>或者说，发生在我们身边的所有的事件，是一个很复杂的组合体，里面充满了更独立、更小型的事件单元，这些单元之间，则是有各种各样的交互和组织关系。</p>
<p>其实就像后者描述的这样，顺序处理 (Sequential processing) 并不是完美的建模思路。</p>
<h3 id="什么是并发？"><a href="#什么是并发？" class="headerlink" title="什么是并发？"></a>什么是并发？</h3><p>并发是独立的计算任务的组合。</p>
<p>并发是一种软件的设计模式，用并发的思维模式，可以编写出更清晰的代码。</p>
<h3 id="并发-concurrency-不是并行-parallelism"><a href="#并发-concurrency-不是并行-parallelism" class="headerlink" title="并发 (concurrency) 不是并行 (parallelism)"></a>并发 (concurrency) 不是并行 (parallelism)</h3><p>并发不是并行，但是可以在并行的基础上形成并发。</p>
<p>如果只有一个单核处理器(单线程模式)，则谈不上并行，但是仍然可以写出并发的代码。</p>
<p>另一方面，如果一段代码已经按照并发的思路进行了设计，那它也是可以很容易的在多核处理器(多线程模式)中并行执行。</p>
<p><em>关于这个话题，更详细的讨论可以参看 <a href="http://talks.golang.org/2012/waza.slide" target="_blank" rel="external">Concurrency is not Parallelism</a></em><br><a id="more"></a></p>
<h3 id="什么是好的代码架构"><a href="#什么是好的代码架构" class="headerlink" title="什么是好的代码架构"></a>什么是好的代码架构</h3><ul>
<li>要容易理解</li>
<li>要容易使用</li>
<li>要容易描述出设计意图</li>
<li>不需要人人都是专家 (不应该总是出现大量threads，semaphores，locks，barriers等等高深的话题)</li>
</ul>
<h3 id="CSP-的历史"><a href="#CSP-的历史" class="headerlink" title="CSP 的历史"></a>CSP 的历史</h3><p>CSP 并不是新技术，Communicating Sequential Processes 是 Tony Hoare 在 1978 年就提出来的概念，甚至在更早的 1975 年，Edsger Dijkstra 的 Guarded Command Language 里面，也能看到 CSP 的影子。</p>
<p>还有其他的一些语言，也有类似的并发模型</p>
<ul>
<li>Occam (May, 1983)</li>
<li>Erlang (Armstrong, 1986)</li>
<li>Newsqueak (Pike, 1988)</li>
<li>Concurrent ML (Reppy, 1993)</li>
<li>Alef (Winterbottom, 1995)</li>
<li>Limbo (Dorward, Pike, Winterbottom, 1996).</li>
</ul>
<h3 id="Venice-Golang-和-Erlang-的差异"><a href="#Venice-Golang-和-Erlang-的差异" class="headerlink" title="Venice / Golang 和 Erlang 的差异"></a>Venice / Golang 和 Erlang 的差异</h3><p>Venice / Golang 通过 channels 来实现 CSP。</p>
<p>Erlang 是最接近于原始的 CSP 定义的，通过 name 进行通信，而非 channel。</p>
<p>它们的模型其实是一致的，只不过具体的表现形式有差异。</p>
<p>粗略来看相当于：writing to a file by name (process, Erlang) vs. writing to a file descriptor (channel, Venice / Golang).</p>
<h3 id="CSP-的基本使用"><a href="#CSP-的基本使用" class="headerlink" title="CSP 的基本使用"></a>CSP 的基本使用</h3><p>这篇文章最主要的目的是讨论并发模式，为了避免陷入编程语言本身的各种细节，我们只会使用到 Swift 很少的语法特性。</p>
<h4 id="从下面这个简单的-boring-函数开始"><a href="#从下面这个简单的-boring-函数开始" class="headerlink" title="从下面这个简单的 boring 函数开始"></a>从下面这个简单的 boring 函数开始</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>...<span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>"</span>)</span><br><span class="line">        usleep(<span class="number">100</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run01</span><span class="params">()</span></span> &#123;</span><br><span class="line">    boring(<span class="string">"this is a boring func"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很容易想象到，这段代码的执行结果会是下买这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">this is a boring func 0</span><br><span class="line">this is a boring func 1</span><br><span class="line">this is a boring func 2</span><br><span class="line">this is a boring func 3</span><br><span class="line">this is a boring func 4</span><br><span class="line">this is a boring func 5</span><br><span class="line">this is a boring func 6</span><br><span class="line">this is a boring func 7</span><br><span class="line">this is a boring func 8</span><br><span class="line">this is a boring func 9</span><br><span class="line">this is a boring func 10</span><br></pre></td></tr></table></figure>
<h4 id="稍微改动一下"><a href="#稍微改动一下" class="headerlink" title="稍微改动一下"></a>稍微改动一下</h4><p>增加一点随机的延时，让 message 出现的时机不可预测 (延迟时间仍然控制在1秒之内)。并且让 boring 函数一直循环运行。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>"</span>)</span><br><span class="line">        usleep(<span class="number">1000</span> * (arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run02</span><span class="params">()</span></span> &#123;</span><br><span class="line">    boring(<span class="string">"this is a less boring func"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="进入正题"><a href="#进入正题" class="headerlink" title="进入正题"></a>进入正题</h4><p>Venice 的 co 函数，传入的参数是一个函数，在 co 的内部会执行这个传入的函数，但是并不会等待这个函数执行结束，对于 co 的调用者来说，co 函数本身会立刻返回。co 函数其实是开启了一个新的协程 (轻量级线程) 来真正的执行传入的函数。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>"</span>)</span><br><span class="line">        nap(<span class="keyword">for</span>: <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds)<span class="comment">//sleep</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run03</span><span class="params">()</span></span> &#123;</span><br><span class="line">    co &#123;</span><br><span class="line">        boring(<span class="string">"co a less boring func"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">    //if do not want run03() finish, run the loop below</span><br><span class="line">    for i in 0..&lt;Int.max &#123;</span><br><span class="line">        yield</span><br><span class="line">    &#125;</span><br><span class="line">    */</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"run03() will return"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段代码的运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">co a less boring func 0</span><br><span class="line">run03() will return</span><br></pre></td></tr></table></figure>
<p>可以看到，boring函数里面的循环只执行了一次，这是因为 co 函数是立刻返回的，紧接着，run03() 执行完 print 后也立刻返回，然后 run03() 的调用者 main 函数也就执行结束了 (进程结束)，之前 co 启动的协程自然也就无法继续执行了。</p>
<p>如果想让 co 里面的协程一直运行下去，可以在 co 调用返回后，执行代码中的那段 for loop。</p>
<p><em>要注意的一点是，for loop 里面调用的 yield，是 Venice 引入的一种操作，意思是让出 CPU 给其他的协程。Golang 是不需要手动进行这种调用的，runtime 会自动的进行调度。</em></p>
<p><em>在 Venice 里面，如果是在 channel 上进行读写操作，读写的同时已经相当于调用过 yield 了，所以也不需要使用者再次显式的调用 yield。在后面的例子的，就会看到这种不需要手动调用 yield 的场景。</em></p>
<h4 id="继续改动代码"><a href="#继续改动代码" class="headerlink" title="继续改动代码"></a>继续改动代码</h4><p>调整代码成下面这个样子，在 co 调用后，让 run04() 所在的协程 sleep 一小段时间。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>"</span>)</span><br><span class="line">        nap(<span class="keyword">for</span>: <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run04</span><span class="params">()</span></span> &#123;</span><br><span class="line">    co(boring(<span class="string">"co a less boring func"</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"I'm listening"</span>)</span><br><span class="line">    nap(<span class="keyword">for</span>: <span class="number">2</span>.second)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码的执行结果是下面这个样子的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">co a less boring func 0</span><br><span class="line">I&apos;m listening</span><br><span class="line">co a less boring func 1</span><br><span class="line">co a less boring func 2</span><br><span class="line">co a less boring func 3</span><br><span class="line">co a less boring func 4</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<p><em>nap()是Venice提供的sleep函数，它的内部，相当于调用了yield。</em></p>
<p>当main函数结束的时候，boring函数所在的协程也会结束。</p>
<h4 id="协程-coroutine"><a href="#协程-coroutine" class="headerlink" title="协程 (coroutine)"></a>协程 (coroutine)</h4><p>协程是一段独立运行的代码集合，通过 co 函数来启动。</p>
<p>协程的系统开销是很小的 (比 thread 小很多)，可以同时存在大量的协程 (具体到 Venice 底层使用的 <a href="http://libmill.org/" target="_blank" rel="external">libmill</a>，可以同时运行 <strong>2000万个</strong> 协程，并且每秒可以进行 <strong>5000万次</strong> 协程上下文切换)。</p>
<p>协程不是线程。</p>
<p>一个程序里面，可以只运行一个线程，但是在这个线程里面，可以包含千万个协程。</p>
<p>可以把协程看成是轻量级的线程。</p>
<h4 id="通讯-communication"><a href="#通讯-communication" class="headerlink" title="通讯 (communication)"></a>通讯 (communication)</h4><p>在 run04() 里面，是不能看到在协程中运行的 boring 函数的运行结果的。</p>
<p>boring 函数仅仅是把 msg 打印到了终端上。</p>
<p>想在协程之间真正的传递数据，需要用到通讯 (communication)。</p>
<h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><p>在 Venice 里面，两个协程之间，通过 Channel 进行通讯。</p>
<p>Channel 的基本操作就是下面这3个:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明、初始化</span></span><br><span class="line"><span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">//在channel上发送数据</span></span><br><span class="line">channel.send(<span class="string">"ping"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//在channel上接收数据</span></span><br><span class="line"><span class="keyword">let</span> message = channel.receive()!</span><br></pre></td></tr></table></figure>
<h4 id="使用-Channel"><a href="#使用-Channel" class="headerlink" title="使用 Channel"></a>使用 Channel</h4><p>用 channel 连接 boring 函数和 run05 函数</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg msg: String, channel: SendingChannel&lt;String&gt; )</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">        channel.send(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>"</span>)</span><br><span class="line">        nap(<span class="keyword">for</span>: <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run05</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        boring(msg: <span class="string">"co a less boring func"</span>, channel: channel.sendingChannel)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"You say: <span class="subst">\(channel.receivingChannel.receive()</span>!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">    channel.close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">You say: co a less boring func 0</span><br><span class="line">You say: co a less boring func 1</span><br><span class="line">You say: co a less boring func 2</span><br><span class="line">You say: co a less boring func 3</span><br><span class="line">You say: co a less boring func 4</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="同步-Synchronization"><a href="#同步-Synchronization" class="headerlink" title="同步 (Synchronization)"></a>同步 (Synchronization)</h4><p>在 channel 上的读、写操作，是同步的、阻塞的。</p>
<p>run05() 执行到 channel.receivingChannel.receive()! 的时候，只有当 channel 里面有数据被写入的时候，这个读操作才会返回 (读到数据的时候才返回)，否则 run05() 就会一直在这里等待，不会继续往下执行。</p>
<p>同样的，在 boring 函数里面，执行 channel.send(“(msg) (i)”) 这个写操作的时候，只有当 channel 里面为空的时候，数据才能被写到 channel 里面，channel.send(“(msg) (i)”) 才会返回，否则，send 操作也会阻塞在这里。</p>
<p>在通讯过程中，发送者和接收者，必须都分别完成他们的写和读动作，否则双方就会一直互相等待下去 (死锁)。</p>
<p>channel 在协程之间完成通讯的同时，也达到了同步的目的。</p>
<h4 id="带缓冲的-channel"><a href="#带缓冲的-channel" class="headerlink" title="带缓冲的 channel"></a>带缓冲的 channel</h4><p>可以创建具有 buffer 的 channel。</p>
<p>这种 channel，当 buffer 还没有写满的时候，是没有前面描述的那种同步特性的。</p>
<p>buffering 有点类似 Erlang 语言里面的 mailboxes。</p>
<p>没有特殊理由的时候，不应该使用 buffered channel。</p>
<p>这篇文章后续的讨论，都不会使用 buffer。</p>
<h4 id="Golang-哲学"><a href="#Golang-哲学" class="headerlink" title="Golang 哲学"></a>Golang 哲学</h4><p>Don’t communicate by sharing memory, share memory by communicating.</p>
<h3 id="模式-Patterns"><a href="#模式-Patterns" class="headerlink" title="模式 (Patterns)"></a>模式 (Patterns)</h3><h4 id="Generator-模式：通过函数返回一个-channel-给调用者"><a href="#Generator-模式：通过函数返回一个-channel-给调用者" class="headerlink" title="Generator 模式：通过函数返回一个 channel 给调用者"></a>Generator 模式：通过函数返回一个 channel 给调用者</h4><p>Channel 是一等公民，和 class、struct、closure 同等重要。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            channel.send(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>"</span>)</span><br><span class="line">            nap(<span class="keyword">for</span>: <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run06</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> receivingChannel = boring(<span class="string">"co a less boring func"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"You say: <span class="subst">\(receivingChannel.receive()</span>!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码和前面的代码的运行结果，没有什么差别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">You say: co a less boring func 0</span><br><span class="line">You say: co a less boring func 1</span><br><span class="line">You say: co a less boring func 2</span><br><span class="line">You say: co a less boring func 3</span><br><span class="line">You say: co a less boring func 4</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<p>但是代码本身确有明显的变化，boring 函数返回一个 channel 给调用者，同时，在 boring 函数内部，通过 co 启动一个新的协程做具体的业务，并且通过刚才创建的 channel 把结果发送出去。</p>
<h4 id="利用-channel-作为-service-的接口"><a href="#利用-channel-作为-service-的接口" class="headerlink" title="利用 channel 作为 service 的接口"></a>利用 channel 作为 service 的接口</h4><p>boring 函数对外提供了一个 service，这个 service 运行在独立的协程里面，并且通过channel 把数据传递给 service 的使用者。</p>
<p>可以同时使用多个 service。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            channel.send(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>  (will sleep <span class="subst">\(Int(sleepTime * <span class="number">1000</span>)</span>) ms)"</span>)</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run07</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> ann = boring(<span class="string">"Ann"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(joe.receive()</span>!)"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(ann.receive()</span>!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 996 ms)</span><br><span class="line">Ann 0  (will sleep 681 ms)</span><br><span class="line">Joe 1  (will sleep 173 ms)</span><br><span class="line">Ann 1  (will sleep 147 ms)</span><br><span class="line">Joe 2  (will sleep 750 ms)</span><br><span class="line">Ann 2  (will sleep 374 ms)</span><br><span class="line">Joe 3  (will sleep 318 ms)</span><br><span class="line">Ann 3  (will sleep 705 ms)</span><br><span class="line">Joe 4  (will sleep 126 ms)</span><br><span class="line">Ann 4  (will sleep 828 ms)</span><br><span class="line">You&apos;re both boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="多路复用-Multiplexing"><a href="#多路复用-Multiplexing" class="headerlink" title="多路复用 (Multiplexing)"></a>多路复用 (Multiplexing)</h4><p>前面 run07() 里面的代码，始终都是先从 joe 里面读取数据，然后再从 ann 里面读取。如果 ann 里面的数据早于 joe 里面的数据就发送了，由于 channel 的同步特性，ann channel 其实会阻塞在它的 send 操作上，直到 run07 从 joe 里面读取完数据后，ann 所在的协程才能继续运行。</p>
<p>为了改善这种情况，可以使用 fan-in 模式。不管是 joe 还是 ann，只要有数据准备好并且执行了 send 操作，都可以立刻读取到。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            channel.send(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>  (will sleep <span class="subst">\(Int(sleepTime * <span class="number">1000</span>)</span>) ms)"</span>)</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(input1 input1: ReceivingChannel&lt;String&gt;, input2: ReceivingChannel&lt;String&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            channel.send(input1.receive()!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            channel.send(input2.receive()!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run08</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> ann = boring(<span class="string">"Ann"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = fanIn(input1: joe, input2: ann)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(<span class="built_in">c</span>.receive()</span>!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 75 ms)</span><br><span class="line">Ann 0  (will sleep 473 ms)</span><br><span class="line">Joe 1  (will sleep 57 ms)</span><br><span class="line">Joe 2  (will sleep 219 ms)</span><br><span class="line">Joe 3  (will sleep 20 ms)</span><br><span class="line">Joe 4  (will sleep 723 ms)</span><br><span class="line">Ann 1  (will sleep 712 ms)</span><br><span class="line">Joe 5  (will sleep 377 ms)</span><br><span class="line">Ann 2  (will sleep 431 ms)</span><br><span class="line">Joe 6  (will sleep 228 ms)</span><br><span class="line">You&apos;re both boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="回复消息-Restoring-sequencing"><a href="#回复消息-Restoring-sequencing" class="headerlink" title="回复消息 (Restoring sequencing)"></a>回复消息 (Restoring sequencing)</h4><p>前面 run08 里面的 fan-in 模式，boring 函数只负责 send 消息，并不需要消息的接收者做一个答复。如果需要，可以像下面这样修改代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">struct</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> str: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> wait: <span class="type">Channel</span>&lt;<span class="type">Bool</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">let</span> waitForIt = <span class="type">Channel</span>&lt;<span class="type">Bool</span>&gt;() <span class="comment">// Shared between all messages</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">Message</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">Message</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> message = <span class="type">Message</span>(str: <span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>  (will sleep <span class="subst">\(Int(sleepTime * <span class="number">1000</span>)</span>) ms)"</span>, wait: waitForIt)</span><br><span class="line">            </span><br><span class="line">            channel.send(message)</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            waitForIt.receive()!</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(input1 input1: ReceivingChannel&lt;Message&gt;, input2: ReceivingChannel&lt;Message&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">Message</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">Message</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            channel.send(input1.receive()!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            channel.send(input2.receive()!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run09</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> ann = boring(<span class="string">"Ann"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = fanIn(input1: joe, input2: ann)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">5</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> message1 = <span class="built_in">c</span>.receive()!</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(message1.str)</span>"</span>)</span><br><span class="line">        message1.wait.send(<span class="literal">true</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> message2 = <span class="built_in">c</span>.receive()!</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(message2.str)</span>"</span>)</span><br><span class="line">        message2.wait.send(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果会是下面这个样子，并没有明显的区别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 551 ms)</span><br><span class="line">Ann 0  (will sleep 53 ms)</span><br><span class="line">Ann 1  (will sleep 543 ms)</span><br><span class="line">Joe 1  (will sleep 412 ms)</span><br><span class="line">Ann 2  (will sleep 847 ms)</span><br><span class="line">Joe 2  (will sleep 46 ms)</span><br><span class="line">Joe 3  (will sleep 274 ms)</span><br><span class="line">Joe 4  (will sleep 69 ms)</span><br><span class="line">Joe 5  (will sleep 202 ms)</span><br><span class="line">Ann 3  (will sleep 962 ms)</span><br><span class="line">You&apos;re both boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h4><p>前面介绍的多路复用技术，是通过启动多个协程实现的，每个 channel 对应一个协程。</p>
<p>另一种更常用的办法，是使用 select 操作，在一个协程里面同时读写多个 channel。</p>
<p>可以用 select 操作重新实现一遍 fan-in 模式</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            channel.send(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>  (will sleep <span class="subst">\(Int(sleepTime * <span class="number">1000</span>)</span>) ms)"</span>)</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(input1 input1: ReceivingChannel&lt;String&gt;, input2: ReceivingChannel&lt;String&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            select &#123; when <span class="keyword">in</span></span><br><span class="line">                when.receive(from: input1) &#123; value <span class="keyword">in</span></span><br><span class="line">                    <span class="comment">//print("received \(value)")</span></span><br><span class="line">                    channel.send(value)</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                when.receive(from: input2) &#123; value <span class="keyword">in</span></span><br><span class="line">                    channel.send(value)</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                when.otherwise &#123;</span><br><span class="line">                    <span class="comment">//print("default case")</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run10</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> ann = boring(<span class="string">"Ann"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = fanIn(input1: joe, input2: ann)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(<span class="built_in">c</span>.receive()</span>!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果和之前的 fan-in 没有区别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Ann 0  (will sleep 816 ms)</span><br><span class="line">Joe 0  (will sleep 252 ms)</span><br><span class="line">Joe 1  (will sleep 756 ms)</span><br><span class="line">Ann 1  (will sleep 879 ms)</span><br><span class="line">Joe 2  (will sleep 157 ms)</span><br><span class="line">Joe 3  (will sleep 578 ms)</span><br><span class="line">Ann 2  (will sleep 700 ms)</span><br><span class="line">Joe 4  (will sleep 499 ms)</span><br><span class="line">Joe 5  (will sleep 352 ms)</span><br><span class="line">Ann 3  (will sleep 642 ms)</span><br><span class="line">You&apos;re both boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<p><em>这里用的 select 操作，和 Linux / Unix 里面的 select、poll、epoll，都是类似的，只不过前者监听的是 channel，后者监听的是 fd</em></p>
<h4 id="在-Select-的基础上实现超时机制-Timeout"><a href="#在-Select-的基础上实现超时机制-Timeout" class="headerlink" title="在 Select 的基础上实现超时机制 (Timeout)"></a>在 Select 的基础上实现超时机制 (Timeout)</h4><p>定时器是基于 channel 实现出来的，当达到定时时间的时候，定时器 channel 上会发送一个消息。</p>
<p>定时器可以放在 select 操作的里面</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            channel.send(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>  (will sleep <span class="subst">\(Int(sleepTime * <span class="number">1000</span>)</span>) ms)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run11</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">while</span> !done &#123;</span><br><span class="line">        select &#123; when <span class="keyword">in</span></span><br><span class="line">            when.receive(from: joe) &#123; value <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"<span class="subst">\(value)</span>"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            when.timeout(<span class="number">800</span>.millisecond.fromNow()) &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"You are too slow."</span>)</span><br><span class="line">                done = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果是下面这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 48 ms)</span><br><span class="line">Joe 1  (will sleep 706 ms)</span><br><span class="line">Joe 2  (will sleep 747 ms)</span><br><span class="line">Joe 3  (will sleep 304 ms)</span><br><span class="line">You are too slow.</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="Select-操作的整体超时"><a href="#Select-操作的整体超时" class="headerlink" title="Select 操作的整体超时"></a>Select 操作的整体超时</h4><p>前面的 run11，是在每次进入 select 的时候，设置了一个超时 channel。</p>
<p>也可以在 while 循环的外面，设置一个整体的超时 channel，像下面这样</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            channel.send(<span class="string">"<span class="subst">\(msg)</span> <span class="subst">\(i)</span>  (will sleep <span class="subst">\(Int(sleepTime * <span class="number">1000</span>)</span>) ms)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run12</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> timeout = <span class="type">Timer</span>(timingOut: <span class="number">5</span>.second.fromNow()).channel</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">while</span> !done &#123;</span><br><span class="line">        select &#123; when <span class="keyword">in</span></span><br><span class="line">            when.receive(from: joe) &#123; value <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"<span class="subst">\(value)</span>"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            when.receive(from: timeout) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"You are too slow."</span>)</span><br><span class="line">                done = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 586 ms)</span><br><span class="line">Joe 1  (will sleep 226 ms)</span><br><span class="line">Joe 2  (will sleep 297 ms)</span><br><span class="line">Joe 3  (will sleep 850 ms)</span><br><span class="line">Joe 4  (will sleep 442 ms)</span><br><span class="line">Joe 5  (will sleep 525 ms)</span><br><span class="line">Joe 6  (will sleep 730 ms)</span><br><span class="line">Joe 7  (will sleep 227 ms)</span><br><span class="line">Joe 8  (will sleep 630 ms)</span><br><span class="line">Joe 9  (will sleep 411 ms)</span><br><span class="line">You are too slow.</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="取消-quit-channel"><a href="#取消-quit-channel" class="headerlink" title="取消 (quit channel)"></a>取消 (quit channel)</h4><p>boring 函数的调用者，可以主动的让 boring 内部的协程停止工作，也是通过 channel 来实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg msg: String, quit: ReceivingChannel&lt;Bool&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        forSelect &#123; when, done <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            when.send(<span class="string">"<span class="subst">\(msg)</span>, and will sleep <span class="subst">\(Int(sleepTime * <span class="number">1000</span>)</span>) ms"</span>, to: channel) &#123;</span><br><span class="line">                <span class="comment">//print("sent value")</span></span><br><span class="line">            &#125;</span><br><span class="line">            when.receive(from: quit) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                done()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        channel.close()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run13</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> quit = <span class="type">Channel</span>&lt;<span class="type">Bool</span>&gt;()</span><br><span class="line">    <span class="keyword">let</span> joe = boring(msg: <span class="string">"Joe"</span>, quit: quit.receivingChannel)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int64</span>(arc4random_uniform(<span class="number">10</span>) + <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(joe.receive()</span>!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    quit.send(<span class="literal">true</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果仍然是类似的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Joe, and will sleep 154 ms</span><br><span class="line">Joe, and will sleep 390 ms</span><br><span class="line">Joe, and will sleep 133 ms</span><br><span class="line">Joe, and will sleep 520 ms</span><br><span class="line">Joe, and will sleep 752 ms</span><br><span class="line">Joe, and will sleep 482 ms</span><br><span class="line">Joe, and will sleep 47 ms</span><br><span class="line">Joe, and will sleep 359 ms</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="在-quit-channel-上接收消息"><a href="#在-quit-channel-上接收消息" class="headerlink" title="在 quit channel 上接收消息"></a>在 quit channel 上接收消息</h4><p>接着上面的例子，当 run13 向 quit channel 发送 true 的时候，run13 怎样才能知道 boring 函数成功的结束了自己的运行呢？让 boring 告诉它的调用者就行，同样，还是通过 quit channel。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">cleanup</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Here, do clean up"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg msg: String, quit: Channel&lt;String&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        forSelect &#123; when, done <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            when.send(<span class="string">"<span class="subst">\(msg)</span>, and will sleep <span class="subst">\(Int(sleepTime * <span class="number">1000</span>)</span>) ms"</span>, to: channel) &#123;</span><br><span class="line">                <span class="comment">//print("sent value")</span></span><br><span class="line">            &#125;</span><br><span class="line">            when.receive(from: quit) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                cleanup()</span><br><span class="line">                quit.send(<span class="string">"See you!"</span>)</span><br><span class="line">                done()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        channel.close()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run14</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> quit = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    <span class="keyword">let</span> joe = boring(msg: <span class="string">"Joe"</span>, quit: quit)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int64</span>(arc4random_uniform(<span class="number">10</span>) + <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(joe.receive()</span>!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    quit.send(<span class="string">"Bye"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Joe says: <span class="subst">\(quit.receive()</span>!)"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在运行结果会变成下面这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Joe, and will sleep 220 ms</span><br><span class="line">Joe, and will sleep 736 ms</span><br><span class="line">Joe, and will sleep 308 ms</span><br><span class="line">Joe, and will sleep 858 ms</span><br><span class="line">Joe, and will sleep 527 ms</span><br><span class="line">Joe, and will sleep 163 ms</span><br><span class="line">Joe, and will sleep 844 ms</span><br><span class="line">Here, do clean up</span><br><span class="line">Joe says: See you!</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="Daisy-chain"><a href="#Daisy-chain" class="headerlink" title="Daisy-chain"></a>Daisy-chain</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(<span class="keyword">left</span> <span class="keyword">left</span>: Channel&lt;Int&gt;, <span class="keyword">right</span>: Channel&lt;Int&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">left</span>.send(<span class="keyword">right</span>.receive()! + <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run15</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> leftMost = <span class="type">Channel</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">right</span> = leftMost</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">left</span> = leftMost</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">10000</span> &#123;</span><br><span class="line">        <span class="keyword">right</span> = <span class="type">Channel</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">        co &#123;</span><br><span class="line">            f(<span class="keyword">left</span>: <span class="keyword">left</span>, <span class="keyword">right</span>: <span class="keyword">right</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">left</span> = <span class="keyword">right</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">right</span>.send(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Joe says: <span class="subst">\(leftMost.receive()</span>!)"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Joe says: 10001</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h3 id="系统软件-Systems-Software"><a href="#系统软件-Systems-Software" class="headerlink" title="系统软件 (Systems Software)"></a>系统软件 (Systems Software)</h3><p>让我们具体看一下 CSP 这种并发模型，是如何用在系统软件的开发中的。</p>
<h4 id="例子：Google-Search"><a href="#例子：Google-Search" class="headerlink" title="例子：Google Search"></a>例子：Google Search</h4><p>问: Google search 需要做什么事情?</p>
<p>答: 输入一个搜索关键字 (query)，得到一组搜索结果 (和一些广告)。</p>
<p>问: 怎样获取这样的一组搜索结果？</p>
<p>答: 把搜索关键字分别发送给 Web search service，Image search service，YouTube search service，Maps search service，News search service 等等，然后把它们返回的结果再组合到一起。</p>
<p>那么，怎样做呢？</p>
<h4 id="模拟各种-search-service"><a href="#模拟各种-search-service" class="headerlink" title="模拟各种 search service"></a>模拟各种 search service</h4><p>模拟 3 个 search service，每次执行 search 的时候，随机延时一小段时间。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">GoogleSearchResult</span> = <span class="type">String</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">fakeSearch</span><span class="params">(kind: String)</span></span> -&gt; (<span class="type">String</span>) -&gt; <span class="type">GoogleSearchResult</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">search</span><span class="params">(query: String)</span></span> -&gt; <span class="type">GoogleSearchResult</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">        <span class="comment">//print("--&gt;\(kind) search use time: \(Int(sleepTime * 1000)) ms")</span></span><br><span class="line">        nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="type">GoogleSearchResult</span>(<span class="string">"<span class="subst">\(kind)</span> result for <span class="subst">\(query)</span>, use time: <span class="subst">\(Int(sleepTime * <span class="number">1000</span>)</span>) ms"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> search</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> web = fakeSearch(<span class="string">"web"</span>)</span><br><span class="line"><span class="keyword">let</span> image = fakeSearch(<span class="string">"image"</span>)</span><br><span class="line"><span class="keyword">let</span> video = fakeSearch(<span class="string">"video"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//some util</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">time</span><span class="params">(desc: String, function: <span class="params">()</span></span></span>-&gt;()) &#123;</span><br><span class="line">    <span class="keyword">let</span> start : <span class="type">UInt64</span> = mach_absolute_time()</span><br><span class="line">    function()</span><br><span class="line">    <span class="keyword">let</span> duration : <span class="type">UInt64</span> = mach_absolute_time() - start</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> info : mach_timebase_info = mach_timebase_info(numer: <span class="number">0</span>, denom: <span class="number">0</span>)</span><br><span class="line">    mach_timebase_info(&amp;info)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> total = (duration * <span class="type">UInt64</span>(info.numer) / <span class="type">UInt64</span>(info.denom)) / <span class="type">NSEC_PER_MSEC</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(desc)</span><span class="subst">\(total)</span> ms."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">GoogleSearchResultDebugAble</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">GoogleSearchResult</span>: <span class="title">GoogleSearchResultDebugAble</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"  <span class="subst">\(<span class="keyword">self</span>)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">extension</span> <span class="title">Array</span> <span class="title">where</span> <span class="title">Element</span>: <span class="title">GoogleSearchResultDebugAble</span> </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"google search result is:"</span>)</span><br><span class="line">        <span class="keyword">for</span> searchResult <span class="keyword">in</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            searchResult.log()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Google-Search-1-0"><a href="#Google-Search-1-0" class="headerlink" title="Google Search 1.0"></a>Google Search 1.0</h4><p>google 函数有一个输入参数，返回一个数组。</p>
<p>google 内部按照顺序依次调用 web、image、video search service，然后把它们的结果组装在一个数组内。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">google</span><span class="params">(query: String)</span></span> -&gt; <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> results = <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    results.append(web(query))</span><br><span class="line">    results.append(image(query))</span><br><span class="line">    results.append(video(query))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run17</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    time(<span class="string">"google search v1.0, use time: "</span>) &#123; () -&gt; () <span class="keyword">in</span></span><br><span class="line">        result = google(<span class="string">"CSP"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result?.log()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果是下面这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">google search v1.0, use time: 1237 ms.</span><br><span class="line">google search result is:</span><br><span class="line">  web result for CSP, use time: 743 ms</span><br><span class="line">  image result for CSP, use time: 240 ms</span><br><span class="line">  video result for CSP, use time: 243 ms</span><br></pre></td></tr></table></figure>
<h4 id="Google-Search-2-0"><a href="#Google-Search-2-0" class="headerlink" title="Google Search 2.0"></a>Google Search 2.0</h4><p>并发调用 web、image、video search service，然后等待它们的返回结果。</p>
<p>不使用锁机制，不使用条件状态变量，不使用 callback。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">google</span><span class="params">(query: String)</span></span> -&gt; <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co(channel.send(web(query)))</span><br><span class="line">    co(channel.send(image(query)))</span><br><span class="line">    co(channel.send(video(query)))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> results = <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">3</span> &#123;</span><br><span class="line">        results.append(channel.receive()!)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run18</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    time(<span class="string">"google search v2.0, use time: "</span>) &#123; () -&gt; () <span class="keyword">in</span></span><br><span class="line">        result = google(<span class="string">"CSP"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result?.log()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">google search v2.0, use time: 871 ms.</span><br><span class="line">google search result is:</span><br><span class="line">  image result for CSP, use time: 40 ms</span><br><span class="line">  video result for CSP, use time: 307 ms</span><br><span class="line">  web result for CSP, use time: 864 ms</span><br></pre></td></tr></table></figure>
<p>很明显，并发执行的效果比顺序执行的效果好很多。</p>
<h4 id="Google-Search-2-1"><a href="#Google-Search-2-1" class="headerlink" title="Google Search 2.1"></a>Google Search 2.1</h4><p>还可以加上超时机制，如果某个 search service 执行的时间太长，就不等待它的返回结果。</p>
<p>不使用锁机制，不使用条件状态变量，不使用 callback。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">google</span><span class="params">(query: String)</span></span> -&gt; <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co(channel.send(web(query)))</span><br><span class="line">    co(channel.send(image(query)))</span><br><span class="line">    co(channel.send(video(query)))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> results = <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> timeout = <span class="type">Timer</span>(timingOut: <span class="number">800</span>.milliseconds.fromNow()).channel</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> done == <span class="literal">true</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        select &#123; when <span class="keyword">in</span></span><br><span class="line">            when.receive(from: channel) &#123; value <span class="keyword">in</span></span><br><span class="line">                results.append(value)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            when.receive(from: timeout) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"timeout."</span>)</span><br><span class="line">                done = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run19</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    time(<span class="string">"google search v2.1, use time: "</span>) &#123; () -&gt; () <span class="keyword">in</span></span><br><span class="line">        result = google(<span class="string">"CSP"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result?.log()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果看到下面这种形式的运行结果，则说明是触发了超时的条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">timeout.</span><br><span class="line">google search v2.1, use time: 810 ms.</span><br><span class="line">google search result is:</span><br><span class="line">  web result for CSP, use time: 341 ms</span><br><span class="line">  video result for CSP, use time: 537 ms</span><br></pre></td></tr></table></figure>
<h4 id="避免超时"><a href="#避免超时" class="headerlink" title="避免超时"></a>避免超时</h4><p>问：怎样才能避免丢弃响应速度更慢的服务器返回的搜索结果？</p>
<p>答：使用 Replicate 策略。同时向多个同类型的 search service 发送请求，使用第一个返回来的查询结果。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">first</span><span class="params">(query query: String, replicas: <span class="params">(<span class="params">(String)</span></span></span></span> -&gt; <span class="type">GoogleSearchResult</span>)...) -&gt; <span class="type">GoogleSearchResult</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> search <span class="keyword">in</span> replicas &#123;</span><br><span class="line">        co(channel.send(search(query)))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receive()!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Google-Search-3-0"><a href="#Google-Search-3-0" class="headerlink" title="Google Search 3.0"></a>Google Search 3.0</h4><p>仍然不使用锁机制，不使用条件状态变量，不使用 callback。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> web1 = fakeSearch(<span class="string">"web1"</span>)</span><br><span class="line"><span class="keyword">let</span> web2 = fakeSearch(<span class="string">"web2"</span>)</span><br><span class="line"><span class="keyword">let</span> image1 = fakeSearch(<span class="string">"image1"</span>)</span><br><span class="line"><span class="keyword">let</span> image2 = fakeSearch(<span class="string">"image2"</span>)</span><br><span class="line"><span class="keyword">let</span> video1 = fakeSearch(<span class="string">"video1"</span>)</span><br><span class="line"><span class="keyword">let</span> video2 = fakeSearch(<span class="string">"video2"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">first</span><span class="params">(query query: String, replicas: <span class="params">(<span class="params">(String)</span></span></span></span> -&gt; <span class="type">GoogleSearchResult</span>)...) -&gt; <span class="type">GoogleSearchResult</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> search <span class="keyword">in</span> replicas &#123;</span><br><span class="line">        co(channel.send(search(query)))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receive()!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">google</span><span class="params">(query: String)</span></span> -&gt; <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        channel.send(first(query: query, replicas: web1, web2))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        channel.send(first(query: query, replicas: image1, image2))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        channel.send(first(query: query, replicas: video1, video2))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> results = <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> timeout = <span class="type">Timer</span>(timingOut: <span class="number">1000</span>.milliseconds.fromNow()).channel</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> done == <span class="literal">true</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        select &#123; when <span class="keyword">in</span></span><br><span class="line">            when.receive(from: channel) &#123; value <span class="keyword">in</span></span><br><span class="line">                <span class="comment">//print("receive \(value)")</span></span><br><span class="line">                results.append(value)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            when.receive(from: timeout) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"timeout."</span>)</span><br><span class="line">                done = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run20</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    time(<span class="string">"google search v3.0, use time: "</span>) &#123; () -&gt; () <span class="keyword">in</span></span><br><span class="line">        result = google(<span class="string">"CSP"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result?.log()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">google search v3.0, use time: 506 ms.</span><br><span class="line">google search result is:</span><br><span class="line">  web1 result for CSP, use time: 433 ms</span><br><span class="line">  image1 result for CSP, use time: 434 ms</span><br><span class="line">  video2 result for CSP, use time: 499 ms</span><br></pre></td></tr></table></figure>
<h3 id="不要过度使用"><a href="#不要过度使用" class="headerlink" title="不要过度使用"></a>不要过度使用</h3><p>coroutine 和 channel 是一种很好的设计思想，可以解决某些类型的问题。</p>
<p>但是，有时我们仍然会面对一些需要用传统思路来解决的小问题，也就是基于锁机制 (共享内存)。</p>
<p>这两种不同的技术思路，并不冲突，它们是可以共存的。</p>
<p>正确的工具做正确的事情。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>这篇文章里面的 demo code 位于 <a href="https://github.com/fengjian0106/CSP-tutorial.git" target="_blank" rel="external">https://github.com/fengjian0106/CSP-tutorial.git</a></p>

      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Swift/" rel="tag">#Swift</a>
          
            <a href="/tags/CSP/" rel="tag">#CSP</a>
          
            <a href="/tags/Concurrency/" rel="tag">#Concurrency</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/03/01/基于libcurl的单线程I:O多路复用HTTP框架/" rel="next" title="基于libcurl的单线程I/O多路复用HTTP框架">
                <i class="fa fa-chevron-left"></i> 基于libcurl的单线程I/O多路复用HTTP框架
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/04/17/The-Power-Of-Composition-In-FRP-Part-1/" rel="prev" title="用 ReactiveCocoa 事半功倍的写代码（一）">
                用 ReactiveCocoa 事半功倍的写代码（一） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="QQ邮箱iOS开发组" />
          <p class="site-author-name" itemprop="name">QQ邮箱iOS开发组</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">博客</span>
            </a>
          </div>
          
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么要讨论并发-concurrency"><span class="nav-number">2.</span> <span class="nav-text">为什么要讨论并发 (concurrency)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是并发？"><span class="nav-number">3.</span> <span class="nav-text">什么是并发？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#并发-concurrency-不是并行-parallelism"><span class="nav-number">4.</span> <span class="nav-text">并发 (concurrency) 不是并行 (parallelism)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是好的代码架构"><span class="nav-number">5.</span> <span class="nav-text">什么是好的代码架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSP-的历史"><span class="nav-number">6.</span> <span class="nav-text">CSP 的历史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Venice-Golang-和-Erlang-的差异"><span class="nav-number">7.</span> <span class="nav-text">Venice / Golang 和 Erlang 的差异</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSP-的基本使用"><span class="nav-number">8.</span> <span class="nav-text">CSP 的基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#从下面这个简单的-boring-函数开始"><span class="nav-number">8.1.</span> <span class="nav-text">从下面这个简单的 boring 函数开始</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#稍微改动一下"><span class="nav-number">8.2.</span> <span class="nav-text">稍微改动一下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#进入正题"><span class="nav-number">8.3.</span> <span class="nav-text">进入正题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#继续改动代码"><span class="nav-number">8.4.</span> <span class="nav-text">继续改动代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#协程-coroutine"><span class="nav-number">8.5.</span> <span class="nav-text">协程 (coroutine)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通讯-communication"><span class="nav-number">8.6.</span> <span class="nav-text">通讯 (communication)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Channel"><span class="nav-number">8.7.</span> <span class="nav-text">Channel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用-Channel"><span class="nav-number">8.8.</span> <span class="nav-text">使用 Channel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#同步-Synchronization"><span class="nav-number">8.9.</span> <span class="nav-text">同步 (Synchronization)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#带缓冲的-channel"><span class="nav-number">8.10.</span> <span class="nav-text">带缓冲的 channel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Golang-哲学"><span class="nav-number">8.11.</span> <span class="nav-text">Golang 哲学</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模式-Patterns"><span class="nav-number">9.</span> <span class="nav-text">模式 (Patterns)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Generator-模式：通过函数返回一个-channel-给调用者"><span class="nav-number">9.1.</span> <span class="nav-text">Generator 模式：通过函数返回一个 channel 给调用者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#利用-channel-作为-service-的接口"><span class="nav-number">9.2.</span> <span class="nav-text">利用 channel 作为 service 的接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多路复用-Multiplexing"><span class="nav-number">9.3.</span> <span class="nav-text">多路复用 (Multiplexing)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#回复消息-Restoring-sequencing"><span class="nav-number">9.4.</span> <span class="nav-text">回复消息 (Restoring sequencing)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Select"><span class="nav-number">9.5.</span> <span class="nav-text">Select</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在-Select-的基础上实现超时机制-Timeout"><span class="nav-number">9.6.</span> <span class="nav-text">在 Select 的基础上实现超时机制 (Timeout)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Select-操作的整体超时"><span class="nav-number">9.7.</span> <span class="nav-text">Select 操作的整体超时</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#取消-quit-channel"><span class="nav-number">9.8.</span> <span class="nav-text">取消 (quit channel)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在-quit-channel-上接收消息"><span class="nav-number">9.9.</span> <span class="nav-text">在 quit channel 上接收消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Daisy-chain"><span class="nav-number">9.10.</span> <span class="nav-text">Daisy-chain</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统软件-Systems-Software"><span class="nav-number">10.</span> <span class="nav-text">系统软件 (Systems Software)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#例子：Google-Search"><span class="nav-number">10.1.</span> <span class="nav-text">例子：Google Search</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模拟各种-search-service"><span class="nav-number">10.2.</span> <span class="nav-text">模拟各种 search service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Google-Search-1-0"><span class="nav-number">10.3.</span> <span class="nav-text">Google Search 1.0</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Google-Search-2-0"><span class="nav-number">10.4.</span> <span class="nav-text">Google Search 2.0</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Google-Search-2-1"><span class="nav-number">10.5.</span> <span class="nav-text">Google Search 2.1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#避免超时"><span class="nav-number">10.6.</span> <span class="nav-text">避免超时</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Google-Search-3-0"><span class="nav-number">10.7.</span> <span class="nav-text">Google Search 3.0</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不要过度使用"><span class="nav-number">11.</span> <span class="nav-text">不要过度使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后记"><span class="nav-number">12.</span> <span class="nav-text">后记</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QQ邮箱iOS开发组</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.scheme !== 'Pisces' && (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always')) {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'iosqqmail';
      var disqus_identifier = '2016/04/10/CSP-Concurrency-Patterns-In-Swift/';
      var disqus_title = 'CSP Concurrency Patterns In Swift';
      var disqus_url = 'http://qqmailteam.github.io/2016/04/10/CSP-Concurrency-Patterns-In-Swift/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  

  
  


</body>
</html>
